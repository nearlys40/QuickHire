import{n as y,y as _,r as p,x as w,d as g,c as u,o as f,a as c,F as b,p as v,b as S,t as h,e as N,s as m}from"./index-kCxuKH9d.js";function C(o){try{const[,t]=o.split("."),r=JSON.parse(atob(t)).exp,a=Math.floor(Date.now()/1e3);return r<a}catch{return!0}}async function T(){const o=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token");if(!o||!t)return null;if(!C(o))return o;try{const a=await(await fetch("http://localhost:8000/api/users/token/refresh/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t})})).json();if(a.access)return localStorage.setItem("access_token",a.access),a.access}catch(r){console.error("ðŸ”’ Token refresh failed",r)}return null}const i=p(null),k=p([]),x=p(0),E=w();function F(){const o=async()=>{const s=await T();if(!s){console.warn("[WebSocket] Cannot connect: No valid token");return}const r=`ws://localhost:8000/ws/notifications/?token=${s}`;i.value=new WebSocket(r),i.value.onopen=()=>{console.log("[WebSocket] Connected")},i.value.onmessage=a=>{try{const n=JSON.parse(a.data);n!=null&&n.message&&(k.value.unshift(n),x.value+=1,E.info(`ðŸ”” ${n.message}`))}catch(n){console.error("[WebSocket] Parse error:",n)}},i.value.onclose=()=>{setTimeout(o,3e3)}},t=()=>{var s;(s=i.value)==null||s.close(),i.value=null};return y(o),_(t),{notifications:k,unreadCount:x,socket:i}}const O={class:"max-w-2xl mx-auto p-8"},W={class:"space-y-4"},$=["onClick"],j={class:"flex justify-between items-center"},A={class:"text-base font-medium"},D={key:0,class:"text-xs bg-red-500 text-white px-2 py-0.5 rounded"},J={class:"text-sm text-gray-500 mt-1"},M=g({__name:"NotificationsPage",setup(o){const{notifications:t}=F(),s=async()=>{try{const e=await m.get("/notifications/");t.value=e.data}catch(e){console.error("Failed to load notifications:",e)}},r=async()=>{try{await m.post("/notifications/mark-read/"),t.value.forEach(e=>e.read=!0)}catch(e){console.error("Failed to mark notifications as read:",e)}},a=async e=>{try{if(e.read)return;await m.post(`/notifications/${e.id}/mark-read/`),e.read=!0}catch(d){console.error(`Failed to mark notification ${e.id} as read`,d)}};y(()=>{s()});function n(e){return new Date(e).toLocaleString()}return(e,d)=>(f(),u("div",O,[c("div",{class:"flex justify-between items-center mb-6"},[d[0]||(d[0]=c("h1",{class:"text-2xl font-bold"},"Notifications",-1)),c("button",{onClick:r,class:"text-sm text-blue-600 hover:underline"}," Mark all as read ")]),c("ul",W,[(f(!0),u(b,null,v(N(t),l=>(f(),u("li",{key:l.id,class:"p-4 bg-white border rounded shadow cursor-pointer",onClick:B=>a(l)},[c("div",j,[c("p",A,h(l.message),1),l.read?S("",!0):(f(),u("span",D," NEW "))]),c("p",J,h(n(l.timestamp)),1)],8,$))),128))])]))}});export{M as default};
